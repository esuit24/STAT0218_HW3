---
title: "Stat_Hw3"
author: "Ellie Suit, Andy Atallah, and Ai Hattori"
date: "2023-10-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Research Question: 
Analyze vehicleSearch before and after George Floyd incident
- Use race, preRace, gender, policePrecinct, reason, problem, lat, long as a predictor variable 


Types of Trees: 
- Decision/Regression Tree (rpart) - simplist model 
- Bagged Trees (ipred) - making a bunch of similar trees with different observations and determining oob 
- Random Forest (randomforest) - making a bunch of weak learners and taking majority vote
- Boosting Trees (xgboost) - making one tree model and predicting the error for a given variable X 



```{r}
# import libraries
library(lubridate)
library(sf)
library(tidyverse)
library(rattle)
library(rpart)


# read in csv
stop_data <- read_csv("Minneapolis_Police_Stop_Data.csv")
  
stop_data_factored <- stop_data %>%
  na.omit() %>%
  mutate(time = as_datetime(responseDate),
         reason = factor(reason),
         problem = factor(problem),
         citationIssued = factor(citationIssued),
         personSearch = factor(personSearch),
         vehicleSearch = factor(vehicleSearch),
         preRace = factor(preRace),
         race = factor(race),
         gender = factor(gender),
         policePrecinct = factor(policePrecinct))

stop_data_factored <- stop_data_factored %>%
  mutate(vehicleSearch = case_when(vehicleSearch == 'NO' ~ 0,
                                   vehicleSearch == 'YES' ~ 1),
         personSearch = case_when(personSearch == 'NO' ~ 0,
                                   personSearch == 'YES' ~ 1),
         citationIssued = case_when(citationIssued == 'NO' ~ 0,
                                   citationIssued == 'YES' ~ 1),
         night = case_when(time >= 19 ~ 1,
                           time < 6 ~ 1,
                           TRUE ~ 0))



```


```{r}
gf_date <- as.Date("2020-05-26")
stop_data_factored <- stop_data_factored %>%
  mutate(case = case_when(time <= gf_date ~ 0,
                          time > gf_date ~ 1)) %>%
  mutate(case = factor(case))

before_gf <- stop_data_factored %>%
  filter(case == 0) 
after_gf <- stop_data_factored %>%
  filter(case == 1)


```
```{r}
table(stop_data_factored$race)
```


# Decision Tree
```{r}
#view(stop_data_factored)

tree <- rpart(personSearch ~ race + gender + policePrecinct + reason + problem + case + lat + long + preRace, data = stop_data_factored) 

#TODO: why does this not work for a binary variable vehicleSearch? 
fancyRpartPlot(tree)

```

```{r}
tree1 <- rpart(vehicleSearch ~ race + gender + policePrecinct + reason + problem + case + lat + long + preRace, data = stop_data_factored)


#TODO: why does this not work for a binary variable vehicleSearch? 
fancyRpartPlot(tree1)
```

# Random Forest

```{r}
library(randomForest)

rf_vs <- randomForest(factor(vehicleSearch) ~ preRace + race + gender + case + policePrecinct + night + reason + problem, data = stop_data_factored, cutoff = c(0.999999, 0.000001), ntree = 200, importance = TRUE)





# Questions for TA:
# Why does it seem like I need to set a crazy high cutoff to get positive predictions in when in the simple decision tree it seemed to output values that were not too far away from 0.5 
# It seems like I am forcing the model to make positive predictions but it ends up predicting false positives - is there other parameters I can tune to reduce the number of false negatives (already tried mtry and ntree) 
```


```{r}
rf_vs

table(stop_data_factored$race, stop_data_factored$vehicleSearch)
```

```{r}
library(MASS)
rows_to_keep <- sample(1:nrow(stop_data_factored),
                size = nrow(stop_data_factored)/2)
train <- stop_data_factored[rows_to_keep,]
test <- stop_data_factored[-rows_to_keep,] 

lda_model <- lda(factor(vehicleSearch) ~ preRace + race + gender + policePrecinct + reason + problem, data = train)
preds <- predict(lda_model, test)

table(preds$class, test$vehicleSearch)
```




```{r}
library(randomForest)
rf1 <- randomForest(preRace ~ reason + problem + gender + policePrecinct + night + lat + long, data = stop_data_factored, mtry = 4, importance = TRUE) 

rf2 <- randomForest(race ~ reason + problem  + personSearch + gender + policePrecinct + lat + long, data = stop_data_factored, mtry = 4, importance = TRUE)


view(rf1$importance)

view(rf2$importance) 

rf1
rf2
```






